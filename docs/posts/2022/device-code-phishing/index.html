<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Device Code Phishing Attacks &middot;  Embrace The Red" />
  
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2022/device-code-phishing/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2022-11-21T06:00:33-08:00" />
  
  <meta property="og:article:tag" content="phishing" />
  
  <meta property="og:article:tag" content="red" />
  
  <meta property="og:article:tag" content="ttp" />
  
  <meta property="og:article:tag" content="ropci" />
  
  

  <title>
     Device Code Phishing Attacks &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  

  
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@wunderwuzzi23">
<meta name="twitter:title" content="Device Code Phishing for Access Tokens">
<meta name="twitter:description" content="Hardware tokens and Yubikeys will not protect you from device code phishing.">
<meta name="twitter:image" content="https://embracethered.com/blog/images/2022/device-code-phish.png">

<meta name="twitter:creator" content="@wunderwuzzi23">



  
</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Device Code Phishing Attacks</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2022-11-21T06:00:33-08:00">
          Nov 21, 2022
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/phishing">#phishing</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/ttp">#ttp</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/ropci">#ropci</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>As more organizations move to hardware tokens and password-less auth (e.g. Yubi-keys, Windows Hello for Business,&hellip;) attackers will look for other ways to to trick users to gain access to their data.</p>
<p>One novel phishing technique is by using the <a href="https://www.rfc-editor.org/rfc/rfc8628">OAuth2 Device Authorization Grant</a>.</p>
<p>This post describes how it works with Microsoft AAD as example.</p>
<h1 id="attacker-initiates-the-phishing-flow">Attacker initiates the phishing flow</h1>
<p>The attacker starts a Device Code flow by issuing a request to the device code token endpoint (e.g. <code>https://login.microsoftonline.com/{tenant}.onmicrosoft.com/oauth2/v2.0/devicecode</code>).</p>
<p><a href="https://github.com/wunderwuzzi23/ropci">ropci</a> has this feature built in, but it can be issued with <code>curl</code> or <code>Burp</code>.</p>
<p><code>./ropci auth devicecode</code></p>
<p><a href="/blog/images/2022/device-code-phishing-attacker.png"><img src="/blog/images/2022/device-code-phishing-attacker.png" alt="ropci"></a></p>
<p>The command returns the <code>URL</code> and a <code>Code</code> to complete the authorization.</p>
<h2 id="attacker-sends-the-phishing-email-to-the-victim">Attacker sends the phishing email to the victim</h2>
<p>The attacker grabs the <code>Code</code> puts it into a phishing email:</p>
<p><a href="/blog/images/2022/device-code-phishing.png"><img src="/blog/images/2022/device-code-phishing.png" alt="Device Code Phishing Email"></a></p>
<p>To make the phish more realistic, one can add additional query parameters, like a <code>docid</code> above.</p>
<h2 id="victim-falls-for-the-phish">Victim falls for the phish</h2>
<p>There are a couple of steps the victim has to complete in order to grant authorization:</p>
<p><a href="/blog/images/2022/device-code-phish.png"><img src="/blog/images/2022/device-code-phish.png" alt="Device Code Phishing Steps"></a></p>
<p>The above images shows the individual steps:</p>
<ol>
<li>Click the link in the email and enter the device code</li>
<li>Login to Microsoft Online (in many cases the user might already be logged in)</li>
<li>Authorize the OAuth app (in this example Office, which is the default client_id ropci uses)</li>
<li>Success</li>
</ol>
<p>Completing these steps is necessary before an access token will be issued.</p>
<h2 id="attack-receives-the-access-token">Attack receives the access token</h2>
<p>Once the victim completes the OAuth flow and grants access, the attacker receives the access token!</p>
<p><a href="/blog/images/2022/device-code-phishing-attacker-success.png"><img src="/blog/images/2022/device-code-phishing-attacker-success.png" alt="ropci success - stealing/obtaining access token via device code phishing"></a></p>
<p>The attacker can now use <code>ropci</code> to read the users email, search mail/SharePoint, send mail, read info from all users/groups/apps/devices in the AAD tenant, basically anything that <a href="https://learn.microsoft.com/en-us/graph/use-the-api">Microsoft Graph API</a> allows.</p>
<h1 id="attacker-limitations">Attacker limitations</h1>
<p>There is typically a short time window while the device code is valid, which the attacker has to leverage. This means attack campaigns will be automated at scale to increase chances of success (requesting of token and automatic sending of mails).</p>
<h1 id="mitigations">Mitigations</h1>
<ol>
<li>The easiest is likely to entirely disable the Device Code flow in your organization, unless there is a true business need to support it.</li>
<li>Keeping the time window short to limit an attacker&rsquo;s chance</li>
<li>Reviewing and monitoring the device code flow initiator and the host that grants access. Both of these hosts/devices should likely be coming from a similiar IP address.</li>
</ol>
<h1 id="references">References</h1>
<ul>
<li>RFC -  OAuth 2.0 Device Authorization Grant: <a href="https://www.rfc-editor.org/rfc/rfc8628">https://www.rfc-editor.org/rfc/rfc8628</a></li>
<li>ropci - ROPC Attack tool (<a href="https://github.com/wunderwuzzi23/ropci">https://github.com/wunderwuzzi23/ropci</a>)</li>
<li><a href="https://learn.microsoft.com/en-us/graph/use-the-api">Graph API</a></li>
</ul>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2022/chatgpt-imagine-you-are-a-database/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2022/ropci-usage/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2025
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

