<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Gitlab Reconnaissance Introduction &middot;  Embrace The Red" />
  
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2022/hacking-gitlab-servers/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2022-02-28T04:22:22-07:00" />
  
  <meta property="og:article:tag" content="pentest" />
  
  <meta property="og:article:tag" content="red" />
  
  <meta property="og:article:tag" content="research" />
  
  <meta property="og:article:tag" content="cicd" />
  
  <meta property="og:article:tag" content="devops" />
  
  

  <title>
     Gitlab Reconnaissance Introduction &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  

  
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@wunderwuzzi23">
<meta name="twitter:title" content="Gitlab Reconnaissance Introduction">
<meta name="twitter:description" content="Hacking Gitlab Servers">
<meta name="twitter:image" content="https://embracethered.com/blog/images/2020/hacker.png">

<meta name="twitter:creator" content="@wunderwuzzi23">



  
</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Gitlab Reconnaissance Introduction</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2022-02-28T04:22:22-07:00">
          Feb 28, 2022
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/pentest">#pentest</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/research">#research</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/cicd">#cicd</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/devops">#devops</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>Although Gitlab is not as popular as Github, it’s common to run across it these days. Especially after Microsoft acquired Github it seemed more individuals and organizations flocked over to Gitlab.</p>
<p>In this post I want to document a couple of recon commands that are useful post-exploitation, and for blue teamers to watch out for.</p>
<p>Let&rsquo;s assume one has access to a Gitlab Token as a precursor. Let&rsquo;s walk through some interesting commands and script snippets to leverage to find out more.</p>
<h2 id="found-a-gitlab-token---what-to-do">Found a Gitlab Token - what to do?</h2>
<p>First, let&rsquo;s define a couple environment variables that will be used recurringly.</p>
<pre tabindex="0"><code>TOKEN=$(cat .token)
GITLAB_HOST=[yourserver]
GITLAB_API=&#34;https://$GITLAB_HOST/api/v4&#34;
</code></pre><p>That&rsquo;s it, and these variables are pretty self-explanatory.</p>
<h3 id="who-i-am">Who I Am?</h3>
<p>The first obvious command once a token has been found is to check what user it belongs to.</p>
<pre tabindex="0"><code>curl --silent --header &#34;Authorization: Bearer $TOKEN&#34; &#34;$GITLAB_API/user&#34; | jq .username
</code></pre><p>Note: One can also provide a dedicated HTTP header <code>PRIVATE-TOKEN</code> to the Gitlab instance. More useful information is documented by <a href="https://docs.gitlab.com/ee/security/token_overview.html">Gitlab here</a>.</p>
<h2 id="retrieving-projects">Retrieving Projects</h2>
<p>With a valid token one can enumerate projects:</p>
<pre tabindex="0"><code>curl --silent --header &#34;Authorization: Bearer $TOKEN&#34; \
     &#34;$GITLAB_API/projects/owned=true&amp;simple=true&amp;per_page=100&#34; | jq 
</code></pre><p>An adversary might look for projects they &ldquo;own&rdquo;, so they can do check-ins, like for instance check-in a <code>.gitlab-ci.yml</code> file to modify/create a CI/CD pipeline.</p>
<p>Assuming you have a list of tokens (we are red teamers after all), one can also loop over and call the API with something like this:</p>
<pre tabindex="0"><code>TOKENS=$(cat .tokens)
for T in $TOKENS
do
    curl --silent --header &#34;Authorization: Bearer $T&#34; \
         &#34;$GITLAB_API/projects/owned=true&amp;simple=true&amp;per_page=100&#34; | jq 
done
</code></pre><p>It might also be useful to pipe this information into a file for laters analysis.</p>
<h2 id="cloning-projects">Cloning Projects</h2>
<p>Source Code often contains clear text credentials. To search through the code for secrets and other information Gitlab provides the capability to leverage the API token using <code>git</code> to pull projects from the server.</p>
<p>Here is how this looks like in action:</p>
<pre tabindex="0"><code>PROJ_PATH=MyProject/KoiPhish/KoiPhish.git
git -C ./src/ clone &#34;https://gitlab-ci-token:$TOKEN@$GITLAB_HOST/$PROJ_PATH
</code></pre><p>Notice the username <code>gitlab-ci-token</code> in the URL. There are also a couple of other ways to do this. Again, refer to the <a href="https://docs.gitlab.com/ee/security/token_overview.html">Gitlab documenation</a> for further details.</p>
<h2 id="enumerating-gitlab-cicd-variables">Enumerating Gitlab CI/CD Variables</h2>
<p>Gitlab CI/CD variables are great! Why? Because the often contain clear text secrets as well!</p>
<p>A command to enumerate them is:</p>
<pre tabindex="0"><code>PROJECT_ID=123
curl --silent \
     --header &#34;Authorization: Bearer $TOKEN&#34; \ 
     &#34;$GITLAB_API/projects/$PROJECT_ID/variables&#34; | jq 
</code></pre><p>An adversary might find interesting passwords, tokens, or access keys in CI/CD variables.</p>
<p><strong>Tip: Engineers can protect their variables and not expose them widely. One can use protected variables that are only accessible from certain branches for instance.</strong></p>
<h2 id="group-and-instance-level-variables">Group and Instance-level Variables</h2>
<p>Wait, there is more:</p>
<ul>
<li>Gitlab also has Groups and <a href="https://docs.gitlab.com/ee/api/groups.html">Groups can have variables</a> also!</li>
<li><a href="https://docs.gitlab.com/ee/api/instance_level_ci_variables.html">Instance-level CI/CD variables</a> are only accessible to the administrator.</li>
</ul>
<h2 id="runners-token">Runners Token</h2>
<p>Inside the projects details I also discovered a <code>runners_token</code>.</p>
<pre tabindex="0"><code>PROJECT_ID=123
curl --silent --header &#34;Authorization: Bearer $TOKEN&#34; \
     &#34;$GITLAB_API/projects/$PROJECT_ID&#34; | jq .runners_token | jq 
</code></pre><p>From the Gitlab documentation:</p>
<blockquote>
<p>After registration, the runner receives an authentication token, which it uses to authenticate with GitLab when picking up jobs from the job queue. The authentication token is stored locally in the runner’s config.toml file.</p>
</blockquote>
<p>Initially I assumed that token is the authentication token, but it&rsquo;s actually the <strong>Registration Token</strong>.</p>
<p>It took me a while to realize that. Initially I had tried to verify the token as an auth token using:</p>
<pre tabindex="0"><code>curl --request POST &#34;$GITLAB_API/runners/verify&#34; --form &#34;token=$RUNNER_TOKEN&#34;
</code></pre><p>But that didn&rsquo;t work. Then I realized that the <code>runners_token</code> is the shown in the Projects CI/CD pipelines page as the Registration Token. So, gaining access to this implies that you can register your own runners!</p>
<p>More information on how Runners registration works can be found <a href="https://docs.gitlab.com/runner/register/">here</a>.</p>
<p>Interestingly, just two days ago there was a <a href="https://about.gitlab.com/releases/2022/02/25/critical-security-release-gitlab-14-8-2-released/#runner-registration-token-disclosure-through-quick-actions">critical CVE issued</a> by Gitlab regarding Runner Registration Tokens.</p>
<h2 id="ssh-keys">SSH Keys</h2>
<p>Admins can also get <a href="https://docs.gitlab.com/ee/api/keys.html">SSH keys for users</a> - I have not tried this yet, but it seems like one of these features that shouldn&rsquo;t exist, and I thought to point it out.</p>
<h2 id="detecting-access-anomalies-and-mitigations">Detecting Access Anomalies and Mitigations</h2>
<p>At a high level the biggest challenge for defenders is that it&rsquo;s not obvious when a token was stolen, if it&rsquo;s use is coming from a legitimate user or not.</p>
<ul>
<li>For Blue Teamers identifying access anomalies is a good approach to identify if a token has leaked and is actively being abused by an adversary.</li>
<li>Using Protected Branches and Protected Variables can also help limit exposure - so educate your engineeres and leverage them.</li>
</ul>
<p>There is a lot of good information availabe on the Gitlab documentation pages on how to <a href="https://docs.gitlab.com/runner/security/">lock down</a> tokens and runners as well, so review the information there for more details.</p>
<h2 id="conclusion">Conclusion</h2>
<p>This is a short introduction around Gitlab based recon and CI/CD attacks. There are really a lot of fun avenues for adversaries to abuse DevOps infrastructure. There is a lot of information accessible once one gains access to DevOps infrastructure. Keep an eye out as I will be posting more interesting research down the road.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.gitlab.com/ee/api">Gitlab API Documentation</a></li>
<li><a href="https://docs.gitlab.com/ee/security/token_overview.html">Gitlab Access Token Documenation</a></li>
<li><a href="https://docs.gitlab.com/ee/api/keys.html">SSH keys for users</a></li>
<li><a href="https://about.gitlab.com/releases/2022/02/25/critical-security-release-gitlab-14-8-2-released/#runner-registration-token-disclosure-through-quick-actions">Critical Gitlab CVE</a></li>
</ul>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2022/aws-scaled-command/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2022/log4shell-and-request-forgery-attacks/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2025
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

