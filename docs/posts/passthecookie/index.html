<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Pass the Cookie and Pivot to the Clouds &middot;  wunderwuzzi blog" />
  
  <meta property="og:site_name" content="wunderwuzzi blog" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/passthecookie/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2018-12-16T12:00:00-07:00" />
  
  <meta property="og:article:tag" content="pentesting" />
  
  <meta property="og:article:tag" content="red" />
  
  <meta property="og:article:tag" content="blue" />
  
  <meta property="og:article:tag" content="TTP" />
  
  <meta property="og:article:tag" content="conference" />
  
  

  <title>
     Pass the Cookie and Pivot to the Clouds &middot;  wunderwuzzi blog
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" href="https://embracethered.com/blog/images/apple-touch-icon.png" />
  

</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">wunderwuzzi blog</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        Embrace the Red
        <br><a style="color: greenyellow; font-weight:300;text-decoration: underline; " href="https://www.amazon.com/gp/product/1838828869/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1838828869&linkCode=as2&tag=wunderwuzzi-20&linkId=b6523e937607be47499c6010ff489537">OUT NOW: Cybersecurity Attacks - Red Team Strategies</a> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Pass the Cookie and Pivot to the Clouds</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2018-12-16T12:00:00-07:00">
          Dec 16, 2018
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/pentesting">#pentesting</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/blue">#blue</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/ttp">#TTP</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/conference">#conference</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <h2 id="web-applications-and-services-use-cookies-to-authenticate-sessions-and-users">Web Applications and Services use cookies to authenticate sessions and users.</h2>
<p>An adversary can pivot from a compromised host to Web Applications and Internet Services by stealing authentication cookies from browsers and related processes. At the same time this technique bypasses most multi-factor authentication protocols.</p>
<p>The reason for this is that the final authentication token that the attacker steals is issued after all factors have been validated. Many users persist cookies that are valid for an extended period of time, even if the web application is not actively used. Cookies can be found on disk and also in process memory. Additionally other applications on the targets machine might store sensitive authentication tokens in memory (e.g. apps which authenticate to cloud services). This pivoting technique can be extended to bearer tokens, JWT and the likes.
Pass the Cookie is a post-exploitation technique to perform <a href="https://www.owasp.org/index.php/Session_hijacking_attack">session hijacking</a>.</p>
<p>So, let&rsquo;s Pass the Cookie and Pivot to the Clouds.</p>
<p><strong>Update October 2019:</strong> This tactic is now part of the MITRE ATT&amp;CK Matrix, in particular:</p>
<ul>
<li><a href="https://attack.mitre.org/techniques/T1539/">Credential Access - Steal Web Session Cookie</a></li>
<li><a href="https://attack.mitre.org/techniques/T1506/">Lateral Movement - Web Session Cookie</a></li>
</ul>
<p><strong>Update December 2018:</strong> <a href="https://c3lt.de/35c3/talk/CK3DWH/">Pass the Cookie at the Chaos Communication Congress (35C3)</a></p>
<p>Watch the 35C3 Lightning Talk here:
<a href="https://www.youtube.com/embed/y24_QQjbHFA?start=6630&amp;end=6999s/" title="Pass the Cookie at 35C3"><img src="https://img.youtube.com/vi/y24_QQjbHFA/0.jpg" alt="Video Pass the Cookie"></a></p>
<h2 id="attack-chain">Attack Chain</h2>
<p><strong>Disclaimer:</strong> Always make sure you have proper authorization before pen testing.</p>
<p>Pass the Cookie is done via the following steps (variations exist):</p>
<ol>
<li>Acquire the cookie from the victims browser or other processes (e.g. via process dump, or accessing the cookie storage on disk)</li>
<li>Exfiltrate the necessary authentication cookies</li>
<li>Open Firefox on the attackers machine (or any other machine)</li>
<li>Navigate to the resource to access (the domain the cookie is valid for)</li>
<li>Use the Developer Console and set the cookie via document.cookie=&quot;key=value&rdquo;, or use the UI</li>
<li>Refresh the page and observe being logged in as the victim.</li>
</ol>
<p>The appendix shows examples for Github and Google Cloud Platform by using Google Chrome to pass the cookie.</p>
<h2 id="detections">Detections</h2>
<p>When it comes to detections a few things come to mind:</p>
<ul>
<li>One can monitor on the client side for applications that perform process dumps on browser processes or others.</li>
<li>Monitor for unusual activity on critical web assets (like cloud provider management consoles, etc,..)</li>
<li>Monitor for login anomalies (location, time, unusual access patterns)</li>
<li>Leverage features that cloud providers and web apps provide (Threat Detection, Access logs,&hellip;)</li>
<li>Perform authorized adverserial emulation in your organization to test detections</li>
</ul>
<h2 id="mitigations">Mitigations</h2>
<p>To protect from these attacks its important to stay up to date with security patches, etc. to ensure your host does not get compromised. As seasoned security engineer you assume the worst, and here are some ideas on how to mitigate implications of an attack:</p>
<ul>
<li>Regularly delete persistent cookies, so they get removed from hard drive to limit exposure.</li>
<li>Delete session cookies as well</li>
<li><strong>Be the only Administrator on your machine</strong></li>
<li>Leverage features that cloud providers offer (Threat Detection, IAM, RBAC, Firewalls,&hellip;)</li>
<li>Browse sensitive sites (high value assets) from isolated or dedicated machines</li>
<li>Seperateion of duties</li>
<li>Requiring further authentication proof for sensitive operations can help limit the damage</li>
<li>Requiring client side certificates makes it also more difficult to pass the cookie</li>
</ul>
<h2 id="aquiring-cookies-tools-and-techniques">Aquiring Cookies, Tools and Techniques</h2>
<p>In case you don&rsquo;t won&rsquo;t to write your own toolset, there are a couple of options available to gain access to cookies:</p>
<ul>
<li><strong>firefox_creds</strong> - Access the SQL Lite Cookie Databases</li>
<li><strong>cookie_crimes</strong> - Neat way to grab cookies from Chrome on Macs (also Windows and Linux)</li>
<li><strong>ProcDump</strong> - Swiss army knife to dump strings from any process</li>
</ul>
<p>There are also good articles online describing how to access and decrypt the cookies in the SQL Lite databases yourself - if you&rsquo;d like to do your own research or tool.</p>
<h2 id="pass-the-cookie---cheat-sheet">Pass The Cookie - Cheat Sheet</h2>
<p>Below is a list of some &ldquo;cookies of interest&rdquo; for valuable web applications your organization might use. An adversary might be after those and you could emulate to see if your organization catches the attack.</p>
<p>This list might change over time or have inaccuracies - feel to provide feedback or help amend.</p>
<table>
<thead>
<tr>
<th align="left">Application</th>
<th align="left">Cookie Name</th>
<th align="left">Domain</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Amazon Web Services</td>
<td align="left">aws-userInfo, aws-creds</td>
<td align="left">.amazon.com</td>
<td align="left"><a href="https://console.aws.amazon.com">https://console.aws.amazon.com</a></td>
</tr>
<tr>
<td align="left">Google Cloud Platform</td>
<td align="left">OSID, HSID, SID, SSID, APISID, SAPISID, LSID</td>
<td align="left">.google.com</td>
<td align="left"><a href="https://console.cloud.google.com">https://console.cloud.google.com</a> OSID has to be set on console.cloud.google.com, others on .google.com LSID needed for cross app auth (e.g. GCP to Gmail).</td>
</tr>
<tr>
<td align="left">Microsoft Online</td>
<td align="left">ESTSAUTHPERSISTENT</td>
<td align="left">.microsoftonline.com</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Facebook for Work</td>
<td align="left">c_user, cs</td>
<td align="left">.facebook.com</td>
<td align="left">Also works for regular Facebook</td>
</tr>
<tr>
<td align="left">OneLogin</td>
<td align="left">sub_session_onelogin.com</td>
<td align="left">.onelogin.com</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">GitHub</td>
<td align="left">user_session</td>
<td align="left">.github.com</td>
<td></td>
</tr>
<tr>
<td align="left">Hotmail, Calendar, People</td>
<td align="left">RPSSecAuth</td>
<td align="left">.live.com</td>
<td align="left">Access to hotmail,&hellip; (No OneDrive)</td>
</tr>
<tr>
<td align="left">Gmail</td>
<td align="left">OSID, HSID, SID, SSID, APISID, SAPISID, LSID</td>
<td align="left">.google.com</td>
<td align="left"><a href="https://mail.google.com">https://mail.google.com</a>  For basic mail access only first 4 seem needed.</td>
</tr>
</tbody>
</table>
<p>
<br>
<em>Notice:</em> When setting cookies through the web console, each cookie has to be set individually via document.cookie=&rdquo;&rdquo;.
You can always view the currently set cookies via document.cookie</p>
<p>Also when setting cookies ensure to set them on the correct domain. If in doubt you can try setting them on the root domain.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Pass the Cookie is a powerful post-exploitation technique to pivot from on-premise machines to cloud assets. It can be leveraged to bypass 2FA techniques as the cookie is in the end still a single factor.</p>
<p>Hopefully this was helpful, so you can build better detections, improvements and tests into your infrastructure to catch malicious activity.</p>
<p>If you have any questions or ideas feel free to send me an email at <a href="mailto:security@wunderwuzzi.net">security@wunderwuzzi.net</a>.</p>
<p>You can also follow or DM me on Twitter: <a href="https://twitter.com/wunderwuzzi23">@wunderwuzzi23</a></p>
<p>
</p>
<h2 id="appendix---pass-the-cookie-examples">Appendix - Pass the Cookie Examples</h2>
<p>Example 1) Google Cloud Platform, Gmail,&hellip;</p>
<p>Browse to <a href="http://www.google.com">www.google.com</a> in private mode. We aren&rsquo;t logged in.
<img src="/blog/images/kekse/step1.jpg" alt="Not logged in"></p>
<p>Open Developer Console and set the appropriate cookies (see cheat sheet for cookie details)</p>
<p><img src="/blog/images/kekse/step2.jpg" alt="applying cookie"></p>
<p>Switch to the Applications tab and look at the cookies. You can see that they got set on <a href="http://www.google.com">www.google.com</a>, which is not what we want.</p>
<p><img src="/blog/images/kekse/step3.jpg" alt="Logged In"></p>
<p>Update the domain setting of the cookies to .google.com. The cookie for OSID has to be set to console.cloud.google.com for GCP (it works on .google.com as well, but you might observe cookie mismatch errors later if you want to go to different services outside of GCP).</p>
<p>So this can be a bit of a hiccup at times.
<img src="/blog/images/kekse/step4.jpg" alt="Logged In"></p>
<p>Finally, navigate to <a href="https://console.cloud.google.com">https://console.cloud.google.com</a> and observe being magically logged in. If you set the LSID cookie you can also go to GMail or the Accounts settings page.
<img src="/blog/images/kekse/step5.jpg" alt="Logged In"></p>
<p>Example 2): Pass the Cookie on Github</p>
<p>Browse to the website and observe not being authenticated. No cookies.
<img src="/blog/images/kekse/GH1.png" alt="Not Logged In"></p>
<p>Set the appropriate cookie for the website domain (e.g via developer tools of the browser).
<img src="/blog/images/kekse/GH2.png" alt="Pass the Cookie"></p>
<p>Refresh the page and observe being authenticated. :)
<img src="/blog/images/kekse/GH3.png" alt="Logged In"></p>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/lldbbasics/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous disabled"><a href="#"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2021
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

