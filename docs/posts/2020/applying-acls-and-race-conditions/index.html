<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Race conditions when applying ACLs &middot;  wunderwuzzi blog" />
  
  <meta property="og:site_name" content="wunderwuzzi blog" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2020/applying-acls-and-race-conditions/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2020-08-24T12:00:33-08:00" />
  
  <meta property="og:article:tag" content="pentesting" />
  
  <meta property="og:article:tag" content="research" />
  
  <meta property="og:article:tag" content="appsec" />
  
  

  <title>
     Race conditions when applying ACLs &middot;  wunderwuzzi blog
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" href="https://embracethered.com/blog/images/apple-touch-icon.png" />
  

</head>
<body>
    <header class="global-header"  style="background-image:url( /images/bg.jpg )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">wunderwuzzi blog</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        Embrace the Red
        <br><a style="color: greenyellow; font-weight:300;text-decoration: underline; " href="https://www.amazon.com/Cybersecurity-Attacks-Strategies-practical-penetration-ebook/dp/B0822G9PTM">Cybersecurity Attacks - Red Team Strategies</a> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
      
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Race conditions when applying ACLs</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2020-08-24T12:00:33-08:00">
          Aug 24, 2020
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/pentesting">#pentesting</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/research">#research</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/appsec">#appsec</a></span>
        
      </div>
    </div>
  </header>
  <section>
    

<p>Today I&rsquo;m gonna talk about a class of application security issues I ran across a few times over the years. In particular, let&rsquo;s discuss race conditions when it comes to files with sensitive content and permissions.</p>

<p><strong>Race conditions</strong> can allow an adversary to gain access to sensitive information on machines. Assume a system creates a file that contains sensitive information and <em>afterwards</em> applies permissions to lockdown that file.</p>

<h2 id="understanding-the-race-condition">Understanding the race condition</h2>

<p>Let&rsquo;s look at a practical example seen in the wild a few times. Imagine code like this:</p>

<ul>
<li>Code creates file with sensitive information. Doing something like:</li>
</ul>

<pre><code>file.WriteAllBytes(filePath, content);
</code></pre>

<ul>
<li>Then the ACL is updated to lock down the file. <a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesecurity?view=netframework-4.8">Here is a the documentation on how to do that using the FileSecurity class</a>.</li>
</ul>

<p>Hence, you might see <a href="https://docs.microsoft.com/en-us/dotnet/standard/io/how-to-add-or-remove-access-control-list-entries">something similar to the following lines:</a>:</p>

<pre><code>AddFileSecurity(filePath, @&quot;Administrators&quot;,
    FileSystemRights.ReadData, AccessControlType.Allow);
</code></pre>

<p>Aditionally, <em>permission inheritance will be broken</em> by the developer as well (e.g to prevent automatic read access, as otherwise the file likely won&rsquo;t be locked down properly anyways).</p>

<p><em>These two steps of (1) creating the widely exposed file with sensitive content and then (2) locking it down typically can be found right after each other in the source code.</em></p>

<h2 id="exploitable">Exploitable?</h2>

<p>So, what&rsquo;s the chance of an adversary on the machine reading the file right after it was created, but before the permission lockdown happens?</p>

<p>My initial thought was that this could theoretically be exploitable by someone else on the machine, but probably is too narrow of a window for a stable exploit.</p>

<p>Nevertheless, I thought to give it a try and build a little &ldquo;File Stealer&rdquo;.</p>

<h2 id="winning-the-race">Winning the race</h2>

<p>Nothing fancy when it comes to testing for this. I built a simple tool in C# that tries to access the file in a loop and prints out the contents if that is the case.</p>

<p>This is basically the core part of the utility:</p>

<pre><code>while (true)
{
    try
    {
        string content = File.ReadAllText(path);

        Console.WriteLine(&quot;*** SUCCESS: File was grabbed before the ACL got applied! ***&quot;);
        Console.WriteLine(content);
        break;
    }
    catch (Exception ex)
    {
        //Console.Write(&quot;.&quot;); //provide feedback of access denied/file not found
    }
}

Console.WriteLine(&quot;*** Done&quot;);
</code></pre>

<p>The name of the file would have to be known, or be predictable or otherwise retrievable by the attacker.</p>

<h2 id="what-s-the-result-you-might-ask">What&rsquo;s the result you might ask?</h2>

<p><em>Turns out that this works about 100% of the time.</em>  I guess file IO is just really slow&hellip;</p>

<p>Similar coding patterns can be found in other areas, with user accounts, registry or also database configurations. So it&rsquo;s a good to keep this in the back of your head when doing static anlaysis or reviewing code.</p>

<h2 id="how-to-fix">How to fix</h2>

<p>There are typically APIs that will do the correct thing when providing the ACL at creation time. Another options is to not write sensitive information to the file right away, but lock it down first before storing content.</p>

<p>Hope that helps - also if you find something similar, reach out. Curious to see how common that is.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.accesscontrol.filesecurity?view=netframework-4.8">FileSecurity Documentation</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/standard/io/how-to-add-or-remove-access-control-list-entries">AddFileSecurity Example Code</a></li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.file.writeallbytes?view=netcore-3.1">File.WriteAllBytes Documentation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Race_condition">Race Condition Further Information</a></li>
</ul>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2020/attacking-telemetry-and-machine-learning/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2020/shadowbunny-bsides-singapore-virtual-machines/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2020
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

