<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Firefox - Debugger Client for Cookie Access &middot;  Embrace The Red" />
  
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2020/firefox-cookie-debug-client/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2020-07-21T11:00:15-07:00" />
  
  <meta property="og:article:tag" content="red" />
  
  <meta property="og:article:tag" content="blue" />
  
  <meta property="og:article:tag" content="cookies" />
  
  <meta property="og:article:tag" content="ttp" />
  
  <meta property="og:article:tag" content="post-exploitation" />
  
  

  <title>
     Firefox - Debugger Client for Cookie Access &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  

  

  
</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Firefox - Debugger Client for Cookie Access</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2020-07-21T11:00:15-07:00">
          Jul 21, 2020
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/blue">#blue</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/cookies">#cookies</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/ttp">#ttp</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/post-exploitation">#post-exploitation</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>Finally I got to writing some basic tooling for invoking the Firefox debugging API to send commands to the browser and read the responses. This can be useful for grabbing cookies in the post-exploitation phase.</p>
<p>It works for <code>Windows</code> and <code>macOS</code>, should also work on <code>Linux</code>.</p>
<p><a href="/blog/images/2020/firefox/output.png"><img src="/blog/images/2020/firefox/output.png" alt="ffcm output filtered by google.com"></a></p>
<p>This technique is probably most useful when we don&rsquo;t have root or the user&rsquo;s credentials to decrypt cookies or can&rsquo;t attach a regular debugger to the browser process.</p>
<h2 id="source-code">Source code</h2>
<p>The source and additional information is available on <a href="https://github.com/wunderwuzzi23/firefox-cookiemonster">Github</a>.</p>
<h2 id="technical-things">Technical things</h2>
<p>The tool is written in <code>Golang</code> using concurrent sender/receiver routines. It uses basic <code>net.Dial</code> to get a TCP client (<code>Conn</code>) to Firefox.</p>
<p>When the connection is established it sends debug messages as <code>serialized JSON objects</code> to setup things and use the <code>evaluateJSAsync</code> method to run JavaScript.</p>
<p>After my last blog post I noticed the <code>Services.cookies.cookies</code> array which holds all the cookies. So by default it will iterate over and return those.</p>
<h3 id="requests">Requests</h3>
<p>These are the detailed messages the client sends to the server:</p>
<ol>
<li><code>36:{&quot;type&quot;:&quot;listProcesses&quot;,&quot;to&quot;:&quot;root&quot;}</code></li>
<li><code>61:{&quot;type&quot;:&quot;getTarget&quot;,&quot;to&quot;:&quot;server2.conn0.processDescriptor31&quot;}</code></li>
<li><code>60:{&quot;type&quot;:&quot;attach&quot;,&quot;to&quot;:&quot;server2.conn0.parentProcessTarget35&quot;}</code></li>
<li><code>139:{&quot;type&quot;:&quot;evaluateJSAsync&quot;,&quot;text&quot;:&quot;Services.cookies.cookies[0].name&quot;,&quot;to&quot;:&quot;server2.conn0.consoleActor36&quot;}</code></li>
<li><code>103:{Type: &quot;substring&quot;, Start: 1000, End: 186972, To: &quot;server2.conn0.longstractor23&quot;}</code></li>
</ol>
<p>The <code>number</code> before the JSON string is the length of the message. This is needed for proper deserialization by the other party.</p>
<h3 id="sending-javascript-code-to-execute">Sending Javascript code to execute</h3>
<p>The most interesting call is <code>evaluateJSAsync</code> which sends the JavaScript command to execute. If the results are large, we have to call <code>substring</code> to get all of the results.</p>
<h3 id="responses">Responses</h3>
<p>Responses have the same structure. A typical response from the Firefox debug server looks like this:</p>
<p><code>423:{&quot;processes&quot;:[{&quot;actor&quot;:&quot;server2.conn190.processDescriptor1&quot;,&quot;id&quot;:0,&quot;isParent&quot;:true,&quot;traits&quot;:{&quot;watcher&quot;:true}},{&quot;actor&quot;:&quot;server2.conn190.processDescriptor2&quot;,&quot;id&quot;:6816,&quot;isParent&quot;:false,&quot;traits&quot;:{&quot;watcher&quot;:true}},{&quot;actor&quot;:&quot;server2.conn190.processDescriptor3&quot;,&quot;id&quot;:10700,&quot;isParent&quot;:false,&quot;traits&quot;:{&quot;watcher&quot;:true}},{&quot;actor&quot;:&quot;server2.conn190.processDescriptor4&quot;,&quot;id&quot;:1952,&quot;isParent&quot;:false,&quot;traits&quot;:{&quot;watcher&quot;:true}}],&quot;from&quot;:&quot;root&quot;}</code></p>
<p>What the tool does is to extract the necessary metadata needed to perform the subsequent requests (like extracting infromation, such as the proper <code>Actor</code>).</p>
<h3 id="remarks-about-the-implementation">Remarks about the implementation</h3>
<p>There is likely a better way to implemented this, as Firefox recently (since 78) added a <code>Network.getAllCookies</code> Debug API.</p>
<p>The code leverages a single struct for 5 different &ldquo;kind of&rdquo; messages to the server. The structure is named <code>wireMessage</code> and represents all possible JSON requests/responses. Due to the use of a single message type for all requests/responses it can get a bit messy trying to understand the code. Yay. :)</p>
<h2 id="detections-and-alerting">Detections and alerting</h2>
<p>This is also were detections might come in handy:</p>
<ul>
<li>Looking for <code>-start-debugger-server</code> command line arguments to Firefox</li>
<li>Modification of <code>user.js</code> and <code>prefs.js</code> files, especially modifications to the settings related to enabling remote debugging (see Appendix information for reference)</li>
</ul>
<h2 id="cookie-crimes">Cookie Crimes</h2>
<p>The idea of using a browser&rsquo;s debugging API to access cookies goes to <a href="https://github.com/defaultnamehere/cookie_crimes">Cookie Crimes for Chrome</a> by @mangopdf.</p>
<h2 id="appendix-remote-debugging">Appendix: Remote debugging</h2>
<p>Unlike Chrome, Firefox by default doesn&rsquo;t allow debugging.</p>
<p>To enable remote debugging, the following Firefox settings have to be updated in the profile:</p>
<ul>
<li><em>devtools.debugger.remote-enabled</em></li>
<li><em>devtools.debugger.prompt-connection</em></li>
<li><em>devtools.chrome.enabled</em></li>
</ul>
<p>Afterwards launching a new Firefox instance with <code>-start-debugger-server 9222</code> will have the debugger enabled.</p>
<p>Yes, this means that you have to kill existing Firefox instances or wait until the restarts it. The <code>-new-instance</code> features is not working by Firefox it seems.</p>
<p>There is more info and how-to&rsquo;s about enabling it in the <a href="https://github.com/wunderwuzzi23/firefox-cookiemonster">README</a></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://docs.firefox-dev.tools/backend/protocol.html">Firefox Documentation - Remote Debug Protocol</a></li>
<li><a href="https://github.com/defaultnamehere/cookie_crimes">Cookie Crimes</a></li>
<li><a href="https://embracethered.com/blog/posts/2020/cookies-on-firefox/">Remote Debugging with Firefox</a></li>
<li><a href="https://embracethered.com/blog/posts/2020/chrome-spy-remote-control/">Post-Exploitation: Abusing Chrome&rsquo;s debugging feature to observe and control browsing sessions remotely</a></li>
<li><a href="https://embracethered.com/blog/posts/2020/cookie-crimes-on-mirosoft-edge/">Cookie Crimes and the new Microsoft Edge Browser</a></li>
</ul>
<h2 id="final-remarks">Final remarks</h2>
<p>As always the reminder that pen testing requires authorization from proper stakeholders.</p>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2020/red-teaming-for-privacy/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2020/cookies-on-firefox/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2025
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

