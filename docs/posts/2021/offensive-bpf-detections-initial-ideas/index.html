<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Offensive BPF: Detection Ideas &middot;  Embrace The Red" />
  
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2021/offensive-bpf-detections-initial-ideas/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2021-10-07T08:00:00-07:00" />
  
  <meta property="og:article:tag" content="research" />
  
  <meta property="og:article:tag" content="ebpf" />
  
  <meta property="og:article:tag" content="blue" />
  
  

  <title>
     Offensive BPF: Detection Ideas &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" type="image/x-icon" href="https://embracethered.com/blog/images/favicon.ico" />
  

  
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@wunderwuzzi23">
<meta name="twitter:title" content="Offensive BPF: Detection Ideas">
<meta name="twitter:description" content="Using eBPF in offensive security settings and mitigations">
<meta name="twitter:image" content="https://embracethered.com/blog/images/2021/obpf-detections.png">

<meta name="twitter:creator" content="@wunderwuzzi23">



  
</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><div style="color: greenyellow; font-weight:400;">learn the hacks, stop the attacks.</div> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Offensive BPF: Detection Ideas</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2021-10-07T08:00:00-07:00">
          Oct 7, 2021
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/research">#research</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/ebpf">#ebpf</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/blue">#blue</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>This post is part of a series about <strong>Offensive BPF</strong> that I&rsquo;m working on to learn how BPFs use will impact offensive security, malware and detection engineering.</p>
<p>Click the <a href="/blog/tags/ebpf">&ldquo;ebpf&rdquo;</a> tag to see all relevant posts.</p>
<p><img src="/blog/images/2021/offensive-bpf.png" alt="Offensive BPF"></p>
<p>In the last few posts, we talked about a <code>bpftrace</code> and how attackers can use it to their advantage. This post is about my initial ideas and strategies to detecting malicious usage.</p>
<h2 id="detecting-bpf-misuse">Detecting BPF misuse</h2>
<p>There are a set of detection ideas for Blue Teams. Since we primarily talked about <code>bpftrace</code> so far, let&rsquo;s explore that angle.</p>
<p>There will be more recommendations down the road as I learn and understand BPF better.</p>
<h3 id="telemetry">Telemetry</h3>
<p>Collecting telemetry around <a href="https://www.kernel.org/doc/html/latest/userspace-api/ebpf/syscall.html">BPF syscalls</a> is a crucial to getting insights into its usage across the fleet. Make sure that whatever tool or product you are using does collect the proper information and that it is centrally available in your threat detection pipeline.</p>
<h3 id="inspecting-loaded-bpf-programs">Inspecting loaded BPF programs</h3>
<p>Loaded BPF programs can be inspected via the <code>bpftool</code>.</p>
<p>For instance, <code>bpftool prog</code> will show you the details and you can see the loaded programs:</p>
<p><img src="/blog/images/2021/bpfprog.png" alt="BPF prog output"></p>
<p>With the BPF tools also comes <code>bpflist</code>, which lists all user space programs currently running BPF:</p>
<p><img src="/blog/images/2021/bpflist.png" alt="BPF prog output"></p>
<p>Collecting this information will allow to build an inventory on what BPF running, and if there are any unexpected outliers.</p>
<p>One challenge remaining for defenders is that if a malicous BPF program starts running before log collection or detection tools run, then a BPF program can install itself as a rootkit to evade detections. Be aware of that.</p>
<h3 id="unsafe-bpftrace-usage-and-system-calls">Unsafe bpftrace usage and system() calls</h3>
<p>The usage of a <code>system()</code> call seems very unusual. So, looking for command line logs that contain <code>bpftrace --unsafe</code> seems a good way to catch <strong>dangerous</strong> bpf programs also.</p>
<h3 id="persistence">Persistence</h3>
<p>BPF programs don&rsquo;t survive a reboot, so an adversary will try to restart them (cron jobs, etc..). Be on the lookout.</p>
<h3 id="supply-chain-attack-or-tampering-with-valid-bpf-programs">Supply chain attack or tampering with valid BPF programs</h3>
<p>There is also the attack avenue to backdoor existing programs that performance teams use or that are executed regularly on hosts.</p>
<p>I haven&rsquo;t seen any signature validation approaches yet, which could help detect such changes. Which brings us to the next point of the idea of having an inventory of known good BPF programs.</p>
<h3 id="creating-an-inventory-of-known-bpf-programs">Creating an inventory of known BPF programs</h3>
<p>Creating and maintaining and inventory of valid BPF programs of your environments seems a good strategy. This allows catching unknown ones to investigate.</p>
<h3 id="perform-a-red-team-exercise-using-the-bpf-ttp">Perform a Red Team Exercise using the BPF TTP</h3>
<p>Assume Breach operations can help identify detection and prevention opportunities in your environments. Hence, I&rsquo;d recommend performing a red or purple team operation that emulates usage of malicious BPF programs.</p>
<p><img src="/blog/images/2021/obpf-detections.png" alt="OBPF Detections"></p>
<h3 id="hooking-the-bpf-system-call-itself">Hooking the BPF system call itself!</h3>
<p>A nifty attacker will likely hook the <code>bpf()</code> system call itself to change blue teams reality.</p>
<p>Performing static analysis on BPF programs can help identify such programs, as can monitoring all calls to the <code>bpf</code> system call dynamically.</p>
<h3 id="investigate-and-leverage-existing-bpf-malware-detection-kits">Investigate and leverage existing BPF malware detection kits</h3>
<p>There has not been a lot of work in this regard, but there are two projects I want to look at more closely when it comes to detections:</p>
<ul>
<li><a href="https://github.com/Gui774ume/ebpfkit-monitor">https://github.com/Gui774ume/ebpfkit-monitor</a></li>
<li><a href="https://github.com/pathtofile/bpf-hookdetect">https://github.com/pathtofile/bpf-hookdetect</a> (might not be just about eBPF, but general kernel rootkits)</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Hope this post is helpful to provide more practical and technical perspective on what defenders need to start looking for.</p>
<p>I&rsquo;m still pretty new to BPF, but the possibilities for attack seem to be limited by creativity, hence <strong>I think BPF malware will be quite common in the not-so-distant future, so letâ€™s get a step ahead with testing and building detections.</strong></p>
<p>Cheers!</p>
<p><a href="https://twitter.com/wunderwuzzi23">@wunderwuzzi23</a></p>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next"><a href="https://embracethered.com/blog/posts/2021/offensive-bpf-handy-tools/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2021/offensive-bpf-bpftrace-message-based/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2025
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  <a href="https://youtube.com/@embracethered" target="_blank">
    <i class="fa fa-youtube"></i>
  </a>
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

